name: Test whisper

on:
    workflow_dispatch:
jobs:
    test:
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
              include:
                - platform: "macos-latest" # for Arm based macs (M1 and above).
                  name: "MacOS (Arm) - aarch64"
      
                - platform: "ubuntu-24.04" # Ubuntu x86_64
                  name: "Ubuntu 24.04 - x86_64"
      
                - platform: "windows-latest" # Windows x86_64
                  name: "Windows - x86_64"

        runs-on: ${{ matrix.platform }}
        name: ${{ matrix.name }}
        steps:
            - uses: actions/checkout@v4
              with:
                repository: 'ggerganov/whisper.cpp'
                ref: 'fe36c909715e6751277ddb020e7892c7670b61d4'

            - name: Prepare Vulkan SDK for Windows
              run: |
                C:\msys64\usr\bin\wget.exe https://sdk.lunarg.com/sdk/download/1.3.290.0/windows/VulkanSDK-1.3.290.0-Installer.exe -O vulkan.exe
                .\vulkan.exe --root C:\vulkan --accept-licenses --default-answer --confirm-command install
                echo "VULKAN_SDK=C:\vulkan" >> $env:GITHUB_ENV
              if: contains(matrix.platform, 'windows')

            - name: Prepare Vulkan SDK for Linux
              run: |
                wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
                sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list http://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list
                sudo apt update
                sudo apt install vulkan-sdk -y
              if: contains(matrix.platform, 'ubuntu')

            - name: Download assets on Windows
              if: contains(matrix.platform, 'windows')
              run: |
                C:\msys64\usr\bin\wget.exe https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin
                C:\msys64\usr\bin\wget.exe https://github.com/thewh1teagle/vibe/raw/main/samples/short.wav
        
            - name: Download assets on Linux
              if: contains(matrix.platform, 'windows') == false
              run: |
                wget https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin
                wget https://github.com/thewh1teagle/vibe/raw/main/samples/short.wav

            - name: Build
              run: |
                cmake -B build -DGGML_VULKAN=ON -DGGML_CCACHE=OFF -DBUILD_SHARED_LIBS=OFF -DCMAKE_BUILD_TYPE=Release -DGGML_STATIC=ON
                cmake --build build --config Release

            - name: Test Windows
              if: contains(matrix.platform, 'windows')
              run: |
                .\build\bin\Release\main -m ggml-tiny.bin -f short.wav

            - name: Test Unix
              if: ${{ contains(matrix.platform, 'ubuntu') || contains(matrix.platform, 'macos') }}
              run: |
                  ./build/bin/main -m ggml-tiny.bin -f short.wav
